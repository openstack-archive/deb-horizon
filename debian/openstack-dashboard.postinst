#!/bin/sh

set -e

if [ "$1" = "configure" ] ; then
	adduser --system \
		--home /var/lib/horizon \
		--quiet \
		--disabled-password \
		--group horizon

	mkdir -p /var/lib/openstack-dashboard/secret-key
	chown www-data:www-data /var/lib/openstack-dashboard/secret-key

	mkdir -p /etc/openstack-dashboard
	if ! [ -f /etc/openstack-dashboard/local_settings.py ] ; then
		cp /usr/share/openstack-dashboard/local_settings.py /etc/openstack-dashboard/local_settings.py
	fi

	if [ -d '/usr/share/openstack-dashboard/static' ] ; then
		rm -rf /usr/share/openstack-dashboard/static
	fi
	ln -s /var/lib/openstack-dashboard/static /usr/share/openstack-dashboard/static

	# Compress the JS and CSS with python-compressor and python-lesscpy
	/usr/share/openstack-dashboard/manage.py collectstatic --clear --noinput
	/usr/share/openstack-dashboard/manage.py compress --force
	if [ -f /var/lib/openstack-dashboard/secret-key/.secret_key_store ]; then
		rm /var/lib/openstack-dashboard/secret-key/.secret_key_store
	fi
	chown -R www-data /var/lib/openstack-dashboard/secret-key /var/lib/openstack-dashboard/static
fi

if [ "$1" = "triggered" ] ; then
	/usr/share/openstack-dashboard/manage.py collectstatic --clear --noinput
	/usr/share/openstack-dashboard/manage.py compress --force
	if [ -f /var/lib/openstack-dashboard/secret-key/.secret_key_store ]; then
		rm /var/lib/openstack-dashboard/secret-key/.secret_key_store
	fi
	chown -R www-data /var/lib/openstack-dashboard/secret-key /var/lib/openstack-dashboard/static
fi

#DEBHELPER#

exit 0
